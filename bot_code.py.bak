from telegram.ext import Application, CommandHandler, MessageHandler
from telegram.ext.filters import Text, COMMAND
from telegram import ReplyKeyboardMarkup, KeyboardButton, Update
from sheets_code import add_article, add_goal, get_articles, get_goals, clear_sheet
import os
import asyncio
from aiohttp import web

# --- –•—ç–Ω–¥–ª–µ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞ (–¥–ª—è Render) ---
async def health_check(request):
    return web.Response(text="OK", status=200)

# --- Webhook –¥–ª—è Telegram ---
async def telegram_webhook(request):
    data = await request.json()
    update = Update.de_json(data, app.bot)
    await app.process_update(update)
    return web.Response(text="OK", status=200)

# --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Telegram ---
async def setup_application():
    global app
    app = Application.builder().token("7281433062:AAGozy3VnJ-o7IxUjO16rWOgJLLXw-K-OMM").build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("menu", menu))
    app.add_handler(MessageHandler(Text() & ~COMMAND, handle_message))
    await app.initialize()

# --- –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –±–æ—Ç–∞ –∏ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ ---
async def run():
    await setup_application()

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è Render
    web_app = web.Application()
    web_app.router.add_get("/health", health_check)
    web_app.router.add_post("/telegram", telegram_webhook)

    port = int(os.getenv("PORT", 10000))
    runner = web.AppRunner(web_app)
    await runner.setup()
    site = web.TCPSite(runner, "0.0.0.0", port)
    await site.start()

    # –î–µ—Ä–∂–∏–º –±–æ—Ç–∞ –≤ –∞–∫—Ç–∏–≤–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    await asyncio.Event().wait()

# --- –ö–æ–º–∞–Ω–¥–∞ /start ---
async def start(update, context):
    keyboard = [
        ["‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—å—é", "‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É"],
        ["üìñ –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—å–∏", "üìã –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–¥–∞—á–∏"],
        ["üßº –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ç—å–∏", "üßº –û—á–∏—Å—Ç–∏—Ç—å –∑–∞–¥–∞—á–∏"]
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    await update.message.reply_text("–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=reply_markup)

async def menu(update, context):
    await start(update, context)

# --- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ---
async def handle_message(update, context):
    message = update.message.text
    username = update.message.from_user.username or update.message.from_user.first_name

    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥–µ–π—Å—Ç–≤–∏–µ "–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—á–∏—Å—Ç–∫–∏"
        if 'confirm_clear' in context.user_data:
            sheet_name = context.user_data['confirm_clear']
            if message == "–î–∞ –û—á–∏—Å—Ç–∏—Ç—å!":
                clear_sheet(sheet_name)
                await update.message.reply_text(f"üßº { '–°—Ç–∞—Ç—å–∏' if sheet_name == 'Articles' else '–ó–∞–¥–∞—á–∏' } –æ—á–∏—â–µ–Ω—ã.")
            else:
                await update.message.reply_text("‚úÖ –û—Å—Ç–∞–≤–ª—è–µ–º –≤—Å—ë –∫–∞–∫ –µ—Å—Ç—å.")
            context.user_data.clear()
            return

        # –û—Å–Ω–æ–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
        if 'action' in context.user_data:
            if context.user_data['action'] == 'add_article':
                add_article(message, username)
                await update.message.reply_text("‚úÖ –°—Ç–∞—Ç—å—è –¥–æ–±–∞–≤–ª–µ–Ω–∞.")
            elif context.user_data['action'] == 'add_task':
                add_goal(message, username)
                await update.message.reply_text("‚úÖ –ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞.")
            context.user_data.clear()
        else:
            if message == "‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—å—é":
                context.user_data['action'] = 'add_article'
                await update.message.reply_text("‚úçÔ∏è –ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏:")
            elif message == "‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É":
                context.user_data['action'] = 'add_task'
                await update.message.reply_text("‚úÖ –ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏:")
            elif message == "üìñ –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—å–∏":
                articles = get_articles()
                if articles:
                    response = "\n".join([f"{row[0]}: {row[1]} (–¥–æ–±–∞–≤–∏–ª: {row[2]})" for row in articles if len(row) >= 3])
                    await update.message.reply_text(f"üìñ –°—Ç–∞—Ç—å–∏:\n{response}")
                else:
                    await update.message.reply_text("–ü–æ–∫–∞ –Ω–µ—Ç —Å—Ç–∞—Ç–µ–π.")
            elif message == "üìã –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–¥–∞—á–∏":
                tasks = get_goals()
                if tasks:
                    response = "\n".join([f"{row[0]}: {row[1]} (–¥–æ–±–∞–≤–∏–ª: {row[2]})" for row in tasks if len(row) >= 3])
                    await update.message.reply_text(f"üìã –ó–∞–¥–∞—á–∏:\n{response}")
                else:
                    await update.message.reply_text("–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á.")
            elif message == "üßº –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ç—å–∏":
                context.user_data['confirm_clear'] = 'Articles'
                confirm_keyboard = [["–î–∞ –û—á–∏—Å—Ç–∏—Ç—å!", "–ù–µ—Ç –û—Å—Ç–∞–≤–∏—Ç—å!"]]
                reply_markup = ReplyKeyboardMarkup(confirm_keyboard, resize_keyboard=True)
                await update.message.reply_text("‚ùì –¢–æ—á–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å? –ù–µ –ø—Ä–æ–º–∞—Ö–Ω—É–ª–∏—Å—å?", reply_markup=reply_markup)
            elif message == "üßº –û—á–∏—Å—Ç–∏—Ç—å –∑–∞–¥–∞—á–∏":
                context.user_data['confirm_clear'] = 'Goals'
                confirm_keyboard = [["–î–∞ –û—á–∏—Å—Ç–∏—Ç—å!", "–ù–µ—Ç –û—Å—Ç–∞–≤–∏—Ç—å!"]]
                reply_markup = ReplyKeyboardMarkup(confirm_keyboard, resize_keyboard=True)
                await update.message.reply_text("‚ùì –¢–æ—á–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å? –ù–µ –ø—Ä–æ–º–∞—Ö–Ω—É–ª–∏—Å—å?", reply_markup=reply_markup)
            else:
                await update.message.reply_text("ü§ñ –ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π.")
    except Exception as e:
        await update.message.reply_text(f"‚ö†Ô∏è –û—à–∏–±–∫–∞: {str(e)}")

if __name__ == "__main__":
    asyncio.run(run())
